<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Publish Document</title>
    <link href="tvision.css" rel="stylesheet">
  </head>
  <body>
    <div class="top-menu-bar">
      <a href="/">Home</a>
      <a href="/publish.html">Publish</a>
      <a href="/username.html">Username</a>
    </div>
    <form class="white window">
      <fieldset>
        <legend>Publish a message onto the blockchain</legend>
        <div>
          <input id="parent" placeholder="Parent" value="0x0000000000000000000000000000000000000000">
        </div>
        <div>
          <textarea id="text"></textarea>
        </div>
      </fieldset>
      <p><button type="submit">Submit</button></p>
    </form>
    <script src="deps/web3.min.js"></script>
    <script src="deps/coinbase.min.js"></script>
    <script src="deps/web3modal.min.js"></script>
    <script src="deps/gzip.min.js"></script>
    <script src="wallet.js"></script>
    <script>
      async function submit(event) {
        event.preventDefault();
        const {accounts,web3,config} = await wallet();
        const parent = document.getElementById('parent').value;
        const text = document.getElementById('text').value;
        const gzip = new Zlib.Gzip(new TextEncoder().encode(text));
        const zipped = Array.from(gzip.compress())
          .map(byte => ('0' + byte.toString(16)).slice(-2))
          .join('');
        try {
          const tx = {
            to: config.contracts.Messages.address,
            from: accounts[0],
            data: web3.eth.abi.encodeFunctionCall({
              name: 'post', type: 'function',
              inputs: [
                { type: 'address', name: 'parent' },
                { type: 'bytes', name: 'data' }
              ],
            }, [ parent, '0x' + zipped ])
          };
          tx.gas = await web3.eth.estimateGas(tx);
          await web3.eth.sendTransaction(tx);
        } catch(error) {
          console.log(error);
          alert(error.message || error);
          return;
        }
        console.log('subbed');
      }
      document.querySelector('form').addEventListener('submit', submit);
    </script>
  </body>
</html>
